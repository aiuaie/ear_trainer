<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chord Ear Trainer (C)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;line-height:1.35}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin:8px 0}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0}
  .btn{border:1px solid #ccc;border-radius:10px;padding:8px 12px;background:#fff}
  .btn:disabled{opacity:.5}
  .btn.choice{min-width:64px}
  .controls .btn{font-weight:600}
  .label{font-weight:600}
  .score{font-weight:700}
  .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 10px;margin-right:6px}
  .sep{height:1px;background:#eee;margin:12px 0}
  .muted{color:#666}
</style>
</head>
<body>
  <h1>Chord Ear Trainer — тональность C</h1>

  <div class="card">
    <div class="label">Выбери аккорды для тренировки</div>
    <div id="degree-select" class="row"></div>
    <div class="sep"></div>
    <div class="label">Выбор тоники</div>
    <div class="row" id="tonic-select">
      <label class="pill"><input type="radio" name="tonic" value="I" checked> I (мажор)</label>
      <!-- по договоренности «i (минор)» = аккорд vi (Am) в C -->
      <label class="pill"><input type="radio" name="tonic" value="vi"> i (минор)</label>
    </div>
  </div>

  <div class="card controls">
    <button id="next" class="btn">Прослушать следующую</button>
    <button id="again" class="btn">Прослушать ещё раз</button>
    <span class="pill score" id="score">Очки: 0</span>
  </div>

  <div class="card">
    <div class="label">Последовательность (4 аккорда, 1-й — тоника)</div>
    <div id="choices"></div>
    <div class="muted">Нажимай на варианты под 2-м, 3-м и 4-м аккордами. Правильные/неправильные <b>обозначаются в тексте</b> ✅ / ❌. Окно с «Правильно» не показывается.</div>
  </div>

<script>
/* ===== Модель ===== */
const DEGREE_LABELS = ["I","ii","iii","IV","V","vi","vii°"]; // минорные маленькими
const DEGREE_TO_CHORD = { "I":"C", "ii":"Dm", "iii":"Em", "IV":"F", "V":"G", "vi":"Am", "vii°":"Bmb5" };
// Частоты для аккордов (C dur): простая синус-сборка, WebAudio
const CHORD_FREQS = {
  "C":   [261.63, 329.63, 392.00],
  "Dm":  [293.66, 349.23, 440.00],
  "Em":  [329.63, 392.00, 493.88],
  "F":   [349.23, 440.00, 523.25],
  "G":   [392.00, 493.88, 587.33],
  "Am":  [440.00, 523.25, 659.25],
  "Bmb5":[493.88, 587.33, 698.46]
};

let audioCtx;               // создадим при первом взаимодействии
const DURATION = 1.0;       // сек на аккорд
const GAP = 0.12;           // пауза между аккордами
let allowedDegrees = new Set(["I","IV","V"]); // по умолчанию
let progression = [];       // массив степеней — напр. ["I","IV","V","I"]
let userAnswers = {};       // ключ: index(1..3), значение: выбранная степень
let score = 0;

/* ===== Аудио ===== */
function ensureAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}
function playChordAtTime(degree, startTime) {
  const chord = DEGREE_TO_CHORD[degree];
  const freqs = CHORD_FREQS[chord];
  const now = audioCtx.currentTime;
  const t0 = Math.max(now, startTime);
  const t1 = t0 + DURATION;

  const gain = audioCtx.createGain();
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.4, t0 + 0.03);  // атака
  gain.gain.exponentialRampToValueAtTime(0.0001, t1);      // релиз
  gain.connect(audioCtx.destination);

  freqs.forEach(f=>{
    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.setValueAtTime(f, t0);
    osc.connect(gain);
    osc.start(t0);
    osc.stop(t1);
  });

  return t1;
}
function playProgression(seq){
  ensureAudio();
  let t = audioCtx.currentTime + 0.05;
  seq.forEach((deg, i)=>{
    t = playChordAtTime(deg, t) + GAP;
  });
}

/* ===== UI ===== */
const degSel = document.getElementById('degree-select');
const choicesEl = document.getElementById('choices');
const scoreEl = document.getElementById('score');
const nextBtn = document.getElementById('next');
const againBtn = document.getElementById('again');

// чекбоксы выбора ступеней
DEGREE_LABELS.forEach(label=>{
  const wrap = document.createElement('label');
  wrap.className = 'pill';
  const cb = document.createElement('input');
  cb.type = 'checkbox';
  cb.checked = allowedDegrees.has(label);
  cb.addEventListener('change', ()=>{
    if(cb.checked) allowedDegrees.add(label);
    else allowedDegrees.delete(label);
  });
  wrap.appendChild(cb);
  wrap.appendChild(document.createTextNode(' ' + label));
  degSel.appendChild(wrap);
});

// тоника I (мажор) или i (минор) = vi
function getSelectedTonic(){
  const radios = document.querySelectorAll('input[name="tonic"]');
  for (const r of radios) if (r.checked) return r.value; // "I" или "vi"
  return "I";
}

function setScore(val){
  score = val;
  scoreEl.textContent = `Очки: ${score}`;
  if (score >= 10) {
    addRandomChord();
    setScore(0);
  }
}

function addRandomChord(){
  const notUsed = DEGREE_LABELS.filter(d=>!allowedDegrees.has(d));
  if (notUsed.length){
    const pick = notUsed[Math.floor(Math.random()*notUsed.length)];
    allowedDegrees.add(pick);
    // отметить чекбокс визуально
    [...degSel.querySelectorAll('label')].forEach(lbl=>{
      const txt = lbl.textContent.trim();
      if (txt === pick) lbl.querySelector('input[type="checkbox"]').checked = true;
    });
    alert(`Добавлен аккорд: ${pick}`);
  }
}

function renderChoices(){
  choicesEl.innerHTML = '';
  userAnswers = {};

  progression.forEach((deg, idx)=>{
    const row = document.createElement('div'); row.className = 'row';
    const label = document.createElement('span'); label.className='label';
    label.textContent = `Аккорд ${idx+1}:`;
    row.appendChild(label);

    // кнопки вариантов — из текущего allowedDegrees
    const variants = [...allowedDegrees];
    const isFirst = (idx === 0);

    variants.forEach(choice=>{
      const btn = document.createElement('button');
      btn.className = 'btn choice';
      btn.textContent = choice;
      if (isFirst){
        // первый аккорд фиксированный (тоника); показываем ✅ на нём, остальные блокируем
        if (choice === deg) {
          btn.textContent = `${choice} ✅`;
        } else {
          btn.disabled = true;
        }
      } else {
        btn.addEventListener('click', ()=>{
          if (userAnswers[idx]) return; // уже отвечено
          if (choice === progression[idx]){
            btn.textContent = `${choice} ✅`;
            setScore(score + 1);
          } else {
            btn.textContent = `${choice} ❌`;
            // пометить правильный в этом ряду
            [...row.querySelectorAll('button')].forEach(b=>{
              if (b.textContent.replace(' ✅','') === progression[idx] ||
                  b.textContent.replace(' ❌','') === progression[idx]){
                b.textContent = `${progression[idx]} ✅`;
              }
            });
            setScore(score - 1);
          }
          userAnswers[idx] = choice;
          // проверяем — ответили ли на 3 позиции (2,3,4)
          const answered = [1,2,3].every(i=>userAnswers[i]);
          // без всплывающих окон — просто индикация и очки
        });
      }
      row.appendChild(btn);
    });

    choicesEl.appendChild(row);
  });
}

/* ===== Логика генерации ===== */
function newProgression(){
  // нужен минимум 2 выбранных варианта (иначе бессмысленно)
  const active = [...allowedDegrees];
  if (active.length < 2) {
    alert("Выбери хотя бы 2 аккорда для тренировки.");
    return;
  }
  const tonic = getSelectedTonic(); // "I" или "vi"
  // Собираем: первый = тоника, остальные 3 — случайно из allowedDegrees
  const rest = Array.from({length:3}, ()=> active[Math.floor(Math.random()*active.length)]);
  progression = [tonic, ...rest];
  renderChoices();
  playProgression(progression);
}
function replay(){
  if (progression.length) playProgression(progression);
}

nextBtn.addEventListener('click', ()=>{ ensureAudio(); newProgression(); });
againBtn.addEventListener('click', ()=>{ ensureAudio(); replay(); });

</script>
</body>
</html>
